# Based on the Ubuntu apache2.conf

ServerRoot "/etc/httpd"

# The accept serialization lock file MUST BE STORED ON A LOCAL DISK.
#
LockFile /var/run/httpd/accept.lock

# PidFile: The file in which the server should record its process
# identification number when it starts.
#
PidFile /var/run/httpd/httpd.pid

# Timeout: The number of seconds before receives and sends time out.
#
Timeout 300

# KeepAlive: Whether or not to allow persistent connections (more than
# one request per connection). Set to "Off" to deactivate.
#
KeepAlive Off


# MaxKeepAliveRequests: The maximum number of requests to allow
# during a persistent connection. Set to 0 to allow an unlimited amount.
# We recommend you leave this number high, for maximum performance.
#
MaxKeepAliveRequests 0


# KeepAliveTimeout: Number of seconds to wait for the next request from the
# same client on the same connection.
#
KeepAliveTimeout 2

# AccessFileName: The name of the file to look for in each directory
# for additional configuration directives.  See also the AllowOverride
# directive.
#
AccessFileName .htaccess

# The following lines prevent .htaccess and .htpasswd files from being
# viewed by Web clients.
#
<Files ~ "^\.ht">
    Order allow,deny
    Deny from all
</Files>


# DefaultType is the default MIME type the server will use for a document
# if it cannot otherwise determine one, such as from filename extensions.
# If your server contains mostly text or HTML documents, "text/plain" is
# a good value.  If most of your content is binary, such as applications
# or images, you may want to use "application/octet-stream" instead to
# keep browsers from trying to display binary files as though they are
# text.
#
DefaultType text/plain

#
# HostnameLookups: Log the names of clients or just their IP addresses
# e.g., www.apache.org (on) or 204.62.129.132 (off).
# The default is off because it'd be overall better for the net if people
# had to knowingly turn this feature on, since enabling it means that
# each client request will result in AT LEAST one lookup request to the
# nameserver.
#
HostnameLookups Off

# ErrorLog: The location of the error log file.
# If you do not specify an ErrorLog directive within a <VirtualHost>
# container, error messages relating to that virtual host will be
# logged here.  If you *do* define an error logfile for a <VirtualHost>
# container, that host's errors will be logged there and not here.
#
ErrorLog /var/log/httpd/error.log

#
# LogLevel: Control the number of messages logged to the error_log.
# Possible values include: debug, info, notice, warn, error, crit,
# alert, emerg.
#
LogLevel warn

# COOK-1021: Dummy LoadModule directive to aid module installations
#LoadModule dummy_module modules/mod_dummy.so

# Include module configuration:
# Include /etc/httpd/mods-enabled/*.load
# Include /etc/httpd/mods-enabled/*.conf


LoadModule passenger_module /home/ec2-user/.rvm/gems/ruby-1.9.3-p551@rocky6/gems/passenger-3.0.19/ext/apache2/mod_passenger.so
PassengerRoot /home/ec2-user/.rvm/gems/ruby-1.9.3-p551@rocky6/gems/passenger-3.0.19
PassengerRuby /home/ec2-user/.rvm/wrappers/ruby-1.9.3-p551@rocky6/ruby
PassengerMaxPoolSize 60

# Include ports listing
Listen *:80
NameVirtualHost *:80
Listen *:443
NameVirtualHost *:443

# The following directives define some format nicknames for use with
# a CustomLog directive (see below).
#
LogFormat "%v:%p %h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" vhost_combined
LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%h %l %u %t \"%r\" %>s %b" common
LogFormat "%{Referer}i -> %U" referer
LogFormat "%{User-agent}i" agent


# Include generic snippets of statements
# Include /etc/httpd/conf-enabled/*.conf

# Include the virtual host configurations:
# Include /etc/httpd/sites-enabled/*.conf


<VirtualHost *:80>
  ServerName rtvstaging2.osuosl.org
  ServerAlias rtvstaging2-lb.osuosl.org 
  DocumentRoot /var/www/rocky/public

  RewriteRule ^/privacy.html http://www.rockthevote.com/voter-registration/online-application-system/privacy.html [R=permanent]

  # Rewrite floatbox and widget_loader.js requests to S3
  RewriteRule ^/floatbox/(.*)$ https://s3.amazonaws.com/floatbox/$1 [R=permanent]
  RewriteRule ^/widget_loader.js$ https://s3.amazonaws.com/ovr/widget_loader.js [R=permanent]

  # Display maintenance page if we're doing some work on the site
  RewriteCond %{DOCUMENT_ROOT}/system/maintenance.html -f
  RewriteRule ^.*$ /system/maintenance.html

  # Disable TRACE/TRACK http methods for security reasons
  RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)
  RewriteRule .* - [F]

  ExpiresActive On
  ExpiresByType application/javascript "now plus 1 hour"
  ExpiresByType application/x-javascript "now plus 1 hour"
  ExpiresByType text/javascript "now plus 1 hour"
  ExpiresByType text/css "now plus 1 hour"

  EnableMMAP on
  EnableSendfile on

  <FilesMatch "\.(js|css)$">
    Header add Cache-Control "public"
  </FilesMatch>
  Header add Vary "Accept-Encoding"
  <FilesMatch "\.(js|css|png|jpg|gif|ico)$">
    FileETag None
  </FilesMatch>

  AddOutputFilterByType DEFLATE text/css application/javascript application/x-javascript text/html

  # send files as utf-8
  AddDefaultCharset utf-8

  # vim: set ft=apache :
  Redirect Permanent / https://rtvstaging2.osuosl.org/

  <Directory /var/www/rocky/public>
    Options FollowSymLinks
    AllowOverride ALL
    Order allow,deny
    Allow from all
  </Directory>

  <Directory />
    Options FollowSymLinks
    AllowOverride None
  </Directory>

  <Location /server-status>
    SetHandler server-status
    Order Deny,Allow
    Deny from all
    Allow from 127.0.0.1
  </Location>

  LogLevel info
  CustomLog "|/usr/sbin/rotatelogs /var/log/httpd/rocky/access/%Y%m%d.log 86400" combined
  ErrorLog "|/usr/sbin/rotatelogs /var/log/httpd/rocky/error/%Y%m%d.log 86400"

</VirtualHost>

<VirtualHost *:443>
  ServerName rtvstaging2.osuosl.org
  ServerAlias rtvstaging2-lb.osuosl.org 
  DocumentRoot /var/www/rocky/public
  RewriteEngine On

  SSLEngine On
  SSLCertificateFile /etc/pki/tls/certs/wildcard.pem
  SSLCertificateKeyFile /etc/pki/tls/private/wildcard.key
  SSLCertificateChainFile /etc/pki/tls/certs/wildcard-bundle.crt

  RewriteRule ^/privacy.html http://www.rockthevote.com/voter-registration/online-application-system/privacy.html [R=permanent]

  # Rewrite floatbox and widget_loader.js requests to S3
  RewriteRule ^/floatbox/(.*)$ https://s3.amazonaws.com/floatbox/$1 [R=permanent]
  RewriteRule ^/widget_loader.js$ https://s3.amazonaws.com/ovr/widget_loader.js [R=permanent]

  # Display maintenance page if we're doing some work on the site
  RewriteCond %{DOCUMENT_ROOT}/system/maintenance.html -f
  RewriteRule ^.*$ /system/maintenance.html

  # Disable TRACE/TRACK http methods for security reasons
  RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)
  RewriteRule .* - [F]

  ExpiresActive On
  ExpiresByType application/javascript "now plus 1 hour"
  ExpiresByType application/x-javascript "now plus 1 hour"
  ExpiresByType text/javascript "now plus 1 hour"
  ExpiresByType text/css "now plus 1 hour"

  EnableMMAP on
  EnableSendfile on

  <FilesMatch "\.(js|css)$">
    Header add Cache-Control "public"
  </FilesMatch>
  Header add Vary "Accept-Encoding"
  <FilesMatch "\.(js|css|png|jpg|gif|ico)$">
    FileETag None
  </FilesMatch>

  AddOutputFilterByType DEFLATE text/css application/javascript application/x-javascript text/html

  # send files as utf-8
  AddDefaultCharset utf-8

  # vim: set ft=apache :
  Redirect Permanent / https://rtvstaging2.osuosl.org/

  RailsBaseURI /
  RailsEnv staging
  PassengerRoot /home/ec2-user/.rvm/gems/ruby-1.9.3-p551@rocky6/gems/passenger-3.0.19
  PassengerRuby /home/ec2-user/.rvm/wrappers/ruby-1.9.3-p551@rocky6/ruby

  <Directory /var/www/rocky/public>
    Options FollowSymLinks
    AllowOverride ALL
    Order allow,deny
    Allow from all
  </Directory>

  <Directory />
    Options FollowSymLinks
    AllowOverride None
  </Directory>

  <Location /server-status>
    SetHandler server-status
    Order Deny,Allow
    Deny from all
    Allow from 127.0.0.1
  </Location>

  LogLevel info
  CustomLog "|/usr/sbin/rotatelogs /var/log/httpd/rtvstaging.osuosl.org/access/%Y%m%d.log 86400" combined
  ErrorLog "|/usr/sbin/rotatelogs /var/log/httpd/rtvstaging.osuosl.org/error/%Y%m%d.log 86400"

</VirtualHost>


